<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>A-005 ãƒ­ã‚°ãƒ»çµ±è¨ˆ</title>
<style>
:root{--b:#e5e7eb;--t:#111827;--m:#6b7280;--bg:#fafafa;--card:#fff;--accent:#111827}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;background:var(--bg);color:var(--t);margin:0}
/* Header + Logo */
.app-header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--b)}
.app-header .inner{max-width:1200px;margin:0 auto;padding:12px 24px;display:flex;align-items:center}
.logo-container{display:flex;align-items:center;gap:10px;text-decoration:none}
.logo-icon{width:32px;height:32px;border-radius:8px;background:var(--accent);color:#fff;display:grid;place-items:center;font-weight:800;font-size:.95rem;letter-spacing:.5px}
.logo{font-weight:800;color:var(--t);font-size:1rem}
/* Layout */
.layout{display:grid;grid-template-columns:260px 1fr;gap:20px;max-width:1200px;margin:0 auto;padding:24px}
@media (max-width:960px){.layout{grid-template-columns:1fr}}
.sidenav{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:16px;position:sticky;top:16px;height:max-content}
.sidenav a{display:flex;gap:8px;text-decoration:none;color:var(--t);padding:10px 12px;border-radius:10px;margin:2px 0}
.sidenav a:hover{background:#f3f4f6}.sidenav a.active{background:var(--accent);color:#fff}
.container{max-width:900px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:18px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:900px){.grid-2{grid-template-columns:1fr}}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.muted{color:var(--m)}
.input,.select{border:1px solid var(--b);border-radius:10px;padding:10px 12px;background:#fff}
.btn{display:inline-flex;gap:8px;align-items:center;background:var(--accent);color:#fff;border:0;border-radius:999px;padding:10px 16px;font-weight:600;cursor:pointer;text-decoration:none}
.btn.ghost{background:#374151}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{padding:10px 12px;border-bottom:1px solid var(--b);text-align:left;white-space:nowrap}
.badge{display:inline-block;border-radius:999px;padding:2px 10px;font-weight:700;font-size:.82rem}
.badge.info{background:#eef2ff;color:#1e40af}
.badge.warn{background:#fef3c7;color:#92400e}
.badge.err{background:#fee2e2;color:#991b1b}
hr.sep{border:none;border-top:1px solid var(--b);margin:14px 0}
.chart-wrap{position:relative;width:100%;height:320px}
</style>
</head>
<body>
<header class="app-header">
  <div class="inner">
    <a href="/" class="logo-container" aria-label="AI Creator Agency ãƒ›ãƒ¼ãƒ ">
      <div class="logo-icon">AI</div><div class="logo">Creator Agency</div>
    </a>
  </div>
</header>

<div class="layout">
  <aside class="sidenav">
    <h3>ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
    <a href="/admin">ğŸ“Š ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
    <a href="/admin/users">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
    <a href="/admin/payments">ğŸ’³ æ”¯æ‰•ã„ç®¡ç†</a>
    <a href="/admin/settings">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</a>
    <a href="/admin/logs" class="active">ğŸ“ˆ ãƒ­ã‚°ãƒ»çµ±è¨ˆ</a>
  </aside>

  <main class="container">
    <h1 style="font-size:1.4rem;margin:0 0 6px;">A-005 ãƒ­ã‚°ãƒ»çµ±è¨ˆ</h1>
    <p class="muted" style="margin:0 0 14px;">ã‚¢ã‚¯ã‚»ã‚¹ã€ã‚¨ãƒ©ãƒ¼ã€ç›£æŸ»ãƒ­ã‚°ã‚’å¯è¦–åŒ–ã—ã¾ã™ï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰ã€‚</p>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <select id="range" class="select">
            <option value="7">ç›´è¿‘7æ—¥</option>
            <option value="14" selected>ç›´è¿‘14æ—¥</option>
            <option value="30">ç›´è¿‘30æ—¥</option>
          </select>
          <select id="product" class="select">
            <option value="">å…¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆ</option>
            <option value="course">è¬›åº§</option>
            <option value="seminar">ã‚»ãƒŸãƒŠãƒ¼</option>
            <option value="admin">ç®¡ç†</option>
          </select>
          <button id="apply" class="btn">é©ç”¨</button>
        </div>
        <div class="row">
          <button id="exportCsv" class="btn ghost">CSV æ›¸ãå‡ºã—</button>
        </div>
      </div>
    </section>

    <!-- ãƒãƒ£ãƒ¼ãƒˆ -->
    <section class="grid-2" style="margin-top:12px;">
      <div class="card">
        <div class="row" style="justify-content:space-between;margin-bottom:8px;">
          <strong>ã‚¢ã‚¯ã‚»ã‚¹æ¨ç§»ï¼ˆPV / ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰</strong>
          <span class="muted" id="rangeLabel">ç›´è¿‘14æ—¥</span>
        </div>
        <div class="chart-wrap"><canvas id="chartTraffic"></canvas></div>
      </div>
      <div class="card">
        <div class="row" style="justify-content:space-between;margin-bottom:8px;">
          <strong>ã‚¨ãƒ©ãƒ¼å†…è¨³</strong>
          <span class="muted">HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥</span>
        </div>
        <div class="chart-wrap"><canvas id="chartError"></canvas></div>
      </div>
    </section>

    <!-- ç›£æŸ»ãƒ­ã‚° -->
    <section class="card" style="margin-top:12px;">
      <div class="row" style="justify-content:space-between;margin-bottom:8px;">
        <strong>ç›£æŸ»ãƒ­ã‚°ï¼ˆæœ€æ–°50ä»¶ï¼‰</strong>
        <span class="muted">æ“ä½œã‚¿ã‚¤ãƒ—åˆ¥ã«è‰²åˆ†ã‘</span>
      </div>
      <div style="overflow:auto;">
        <table class="table" id="logTable">
          <thead>
            <tr>
              <th>æ—¥æ™‚</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>æ“ä½œ</th><th>å¯¾è±¡</th><th>è©³ç´°</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- è»½é‡CDNï¼ˆChart.jsï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ========= ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ ========= */
function genDates(n){
  const arr=[]; const d=new Date();
  for(let i=n-1;i>=0;i--){
    const t=new Date(d); t.setDate(d.getDate()-i);
    const m=String(t.getMonth()+1).padStart(2,'0');
    const day=String(t.getDate()).padStart(2,'0');
    arr.push(`${m}/${day}`);
  }
  return arr;
}
function genTraffic(n){
  const pv=[], uv=[];
  let base = 800;
  for(let i=0;i<n;i++){
    const noise = Math.round(Math.random()*200-100);
    const val = Math.max(200, base + noise);
    pv.push(val);
    uv.push(Math.max(80, Math.round(val*0.55 + Math.random()*50)));
    base += Math.round(Math.random()*40-20);
  }
  return {pv, uv};
}
function genErrors(){
  // ä¾‹ï¼š404å¤šã‚ã€500/502å°‘ãªã‚
  return { "200": Math.floor(Math.random()*2000+6000),
           "404": Math.floor(Math.random()*400+900),
           "500": Math.floor(Math.random()*60+80),
           "502": Math.floor(Math.random()*40+50) };
}
const AUDIT_ACTIONS = [
  {type:'info',  text:'ãƒ­ã‚°ã‚¤ãƒ³', target:'ç®¡ç†ç”»é¢', detail:'IP 172.16.0.3'},
  {type:'warn',  text:'è¨­å®šå¤‰æ›´', target:'é€šçŸ¥è¨­å®š', detail:'ãƒ¡ãƒ¼ãƒ«â†’ON'},
  {type:'info',  text:'å—è¬›ç™»éŒ²', target:'Course #102', detail:'student: hanako'},
  {type:'info',  text:'æ”¯æ‰•ã„',   target:'TX-1006', detail:'Stripe: succeeded'},
  {type:'err',   text:'å¤±æ•—æ±ºæ¸ˆ', target:'TX-1007', detail:'card_authentication_failed'},
  {type:'info',  text:'è¿”é‡‘',     target:'TX-1003', detail:'partial refund'},
  {type:'warn',  text:'æ¨©é™å¤‰æ›´', target:'user: miki', detail:'teacher â†’ suspended'},
];

/* ========= ãƒãƒ£ãƒ¼ãƒˆæç”» ========= */
let trafficChart=null, errChart=null;
function drawCharts(days){
  const labels = genDates(days);
  const {pv, uv} = genTraffic(days);
  const errs = genErrors();

  // ã‚¢ã‚¯ã‚»ã‚¹æ¨ç§»
  const ctx1 = document.getElementById('chartTraffic').getContext('2d');
  if(trafficChart) trafficChart.destroy();
  trafficChart = new Chart(ctx1, {
    type:'line',
    data:{
      labels,
      datasets:[
        { label:'PV', data:pv, borderWidth:2, fill:false, tension:.25 },
        { label:'ãƒ¦ãƒ‹ãƒ¼ã‚¯', data:uv, borderWidth:2, fill:false, tension:.25 }
      ]
    },
    options:{
      responsive:true,
      plugins:{ legend:{position:'bottom'} },
      scales:{ y:{ beginAtZero:true } }
    }
  });

  // ã‚¨ãƒ©ãƒ¼å†…è¨³
  const ctx2 = document.getElementById('chartError').getContext('2d');
  if(errChart) errChart.destroy();
  errChart = new Chart(ctx2, {
    type:'bar',
    data:{
      labels:Object.keys(errs),
      datasets:[{ label:'ä»¶æ•°', data:Object.values(errs) }]
    },
    options:{
      responsive:true,
      plugins:{ legend:{display:false} },
      scales:{ y:{ beginAtZero:true } }
    }
  });
}

/* ========= ç›£æŸ»ãƒ­ã‚°ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ ========= */
function badge(type){
  if(type==='info') return '<span class="badge info">INFO</span>';
  if(type==='warn') return '<span class="badge warn">WARN</span>';
  return '<span class="badge err">ERROR</span>';
}
function renderAudit(){
  const tbody = document.querySelector('#logTable tbody');
  const rows=[];
  const now=new Date();
  for(let i=0;i<50;i++){
    const a = AUDIT_ACTIONS[Math.floor(Math.random()*AUDIT_ACTIONS.length)];
    const t=new Date(now); t.setMinutes(now.getMinutes()-i*7);
    const ts = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')} ${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
    const user = ['admin','miho','teacher_miki','student_hanako','ops'][Math.floor(Math.random()*5)];
    rows.push(`<tr>
      <td>${ts}</td>
      <td>${user}</td>
      <td>${badge(a.type)} ${a.text}</td>
      <td>${a.target}</td>
      <td>${a.detail}</td>
    </tr>`);
  }
  tbody.innerHTML = rows.join('');
}

/* ========= CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ========= */
function exportCSV(){
  const rows=[['datetime','user','action','target','detail']];
  document.querySelectorAll('#logTable tbody tr').forEach(tr=>{
    const cols=[...tr.children].map(td=> `"${td.textContent.replace(/"/g,'""')}"`);
    rows.push(cols);
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'audit_logs.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* ========= ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ ========= */
function apply(){
  const days = Number(document.getElementById('range').value || 14);
  const label = document.getElementById('range').selectedOptions[0].textContent;
  document.getElementById('rangeLabel').textContent = label;
  drawCharts(days);
  renderAudit();
}

document.getElementById('apply').onclick = apply;
document.getElementById('exportCsv').onclick = exportCSV;

/* åˆæœŸè¡¨ç¤º */
apply();

/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è‡ªå‹•ä»˜ä¸ï¼ˆURLä¸€è‡´ã§å¼·èª¿ï¼‰ */
(function(){
  var path = location.pathname.replace(/\/+$/,'');
  document.querySelectorAll('.sidenav a').forEach(a=>{
    var href=(a.getAttribute('href')||'').replace(/\/+$/,'');
    if(href && (href===path || (href!=='/' && path.startsWith(href)))) a.classList.add('active');
  });
})();
</script>
</body>
</html>
